<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ADCM VIDEO</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #111; /* Dark mode background */
      color: #f4f7fa; /* Light text for better contrast */
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #f4f7fa; /* Light heading text for better contrast */
      margin-bottom: 15px;
    }
    video {
      border-radius: 10px;
      background: #000;
      max-width: 100%;
    }
    #videoContainer {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
    }
    video.main {
      border: 2px solid #007bff;
      border-radius: 10px;
      width: 60%;
      height: auto;
    }
    video.small {
      border: 2px solid #28a745;
      border-radius: 10px;
      width: 25%;
      height: auto;
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 10;
      box-shadow: 0 0 8px rgba(0,0,0,0.7);
      background: black;
    }
    .scene {
      position: relative;
      display: none;
      justify-content: center;
      align-items: center;
      gap: 10px;
      width: 100%;
      max-width: 900px;
      margin: 0 auto 20px;
      min-height: 360px;
      background: #222; /* Dark mode for scenes */
      border-radius: 12px;
      padding: 10px;
      box-sizing: border-box;
    }
    .scene.active {
      display: flex;
    }
    .scene-name {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 1.2rem;
      color: #fff;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 5px;
    }
    #sceneButtons {
      display: none; /* Hide scene buttons initially */
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      padding: 10px;
      background: #333; /* Dark background for buttons */
      border-radius: 8px;
    }
    #sceneButtons button {
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background: #555;
      color: #f4f7fa;
      transition: background-color 0.3s;
    }
    #sceneButtons button.active {
      background: #007bff;
      color: white;
    }
    select, input, button {
      margin: 5px;
      padding: 10px;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
      background: #333; /* Dark mode buttons */
      color: #f4f7fa; /* Light text for better contrast on dark buttons */
      border: 1px solid #555;
    }
    .toggle-btn {
      background-color: #ccc;
      color: #000;
      cursor: pointer;
      border: none;
    }
    .toggle-btn.active {
      background-color: #007bff;
      color: #fff;
    }
    .hide {
      display: none;
    }
    #editorInfo {
      font-size: 0.9rem;
      color: #f4f7fa; /* Light text for better contrast */
      margin-top: 10px;
    }
    .pre-call, .controls {
      max-width: 900px;
      margin: 0 auto 20px;
    }
    .editor-controls {
      margin-top: 15px;
    }
    .recording-icon {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background-color: red;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      h1 {
        font-size: 1.5rem;
      }
      video.main {
        width: 100%;
        height: auto;
      }
      video.small {
        width: 40%;
        bottom: 5px;
        right: 5px;
      }
      .scene {
        min-height: 240px;
        padding: 5px;
      }
      #sceneButtons button {
        font-size: 0.9rem;
        padding: 6px 10px;
      }
      select, input, button {
        font-size: 0.9rem;
        padding: 8px;
      }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
</head>
<body>

  <h1>ADCM VIDEO</h1>

  <div class="pre-call section">
    <video id="previewVideo" autoplay muted playsinline style="width: 100%; max-width: 600px; border-radius:10px; background:#000;"></video><br>

    <label for="cameraSelect">Cámara del dispositivo:</label>
    <select id="cameraSelect"></select>

    <label for="micSelect">Micrófono del dispositivo:</label>
    <select id="micSelect"></select><br>

    <button id="toggleVideo" class="toggle-btn active">Video Activado</button>
    <button id="toggleAudio" class="toggle-btn active">Micrófono Activado</button><br>

    <input type="checkbox" id="asEditor" /> <label for="asEditor">Entrar como editor (solo editor graba)</label><br>

    <button id="enterCall">Entrar a la llamada</button>
  </div>

  <div class="controls section hide">
    <!-- Escena 1: Solo cámara 1 -->
    <div id="scene1" class="scene">
      <div class="scene-name">Escena 1</div>
      <video id="localVideo1" class="main" autoplay muted playsinline></video>
    </div>

    <!-- Escena 2: Solo cámara 2 -->
    <div id="scene2" class="scene">
      <div class="scene-name">Escena 2</div>
      <video id="remoteVideo2" class="main" autoplay playsinline></video>
    </div>

    <!-- Escena 3 mejorada: dos cámaras verticales lado a lado -->
    <div id="scene3" class="scene">
      <div class="scene-name">Escena 3</div>
      <video id="localVideo3" class="main" autoplay muted playsinline></video>
      <video id="remoteVideo3" class="main" autoplay playsinline></video>
    </div>

    <!-- Escena 4: Ambas horizontal -->
    <div id="scene4" class="scene">
      <div class="scene-name">Escena 4</div>
      <video id="localVideo4" class="main" autoplay muted playsinline></video>
      <video id="remoteVideo4" class="main" autoplay playsinline></video>
    </div>

    <!-- Escena 5: Cam1 grande, Cam2 esquina -->
    <div id="scene5" class="scene">
      <div class="scene-name">Escena 5</div>
      <video id="localVideo5" class="main" autoplay muted playsinline></video>
      <video id="remoteVideo5" class="small" autoplay playsinline></video>
    </div>

    <!-- Escena 6: Cam2 grande, Cam1 esquina -->
    <div id="scene6" class="scene">
      <div class="scene-name">Escena 6</div>
      <video id="remoteVideo6" class="main" autoplay playsinline></video>
      <video id="localVideo6" class="small" autoplay muted playsinline></video>
    </div>

    <div style="margin-top: 15px;">
      <button id="startCall">Crear llamada</button>
      <button id="joinCall">Unirse a llamada</button>
      <input id="callId" placeholder="ID de llamada" style="width: 200px;"/><br><br>

      <button id="startRecording">Iniciar grabación</button>
      <button id="stopRecording" disabled>Detener grabación</button>
    </div>

    <p id="editorInfo" class="hide">Estás en modo editor. Solo tú puedes grabar.</p>
    <div class="editor-controls"></div>
  </div>

  <!-- Move scene buttons to the bottom -->
  <div id="sceneButtons">
    <button data-scene="scene1">Escena 1</button>
    <button data-scene="scene2">Escena 2</button>
    <button data-scene="scene3">Escena 3</button>
    <button data-scene="scene4">Escena 4</button>
    <button data-scene="scene5">Escena 5</button>
    <button data-scene="scene6">Escena 6</button>
  </div>

  <div id="recordingIcon" class="recording-icon"></div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC6shbQniv5FeXnJYaSasbGKdYibDWhxV8",
      authDomain: "fir-rtc-1d4a1.firebaseapp.com",
      databaseURL: "https://fir-rtc-1d4a1-default-rtdb.firebaseio.com",
      projectId: "fir-rtc-1d4a1",
      storageBucket: "fir-rtc-1d4a1.appspot.com",
      messagingSenderId: "786317659414",
      appId: "1:786317659414:web:4b9fe6fecc349647d1d437"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // Global variables
    let localStream1, localStream2, peerConnection, mediaRecorder;
    let recordedChunks = [];
    let isEditor = false;
    let sessionId = null;
    let videoEnabled = true;
    let audioEnabled = true;

    // DOM elements
    const previewVideo = document.getElementById('previewVideo');
    const cameraSelect = document.getElementById('cameraSelect');
    const micSelect = document.getElementById('micSelect');
    const toggleVideoBtn = document.getElementById('toggleVideo');
    const toggleAudioBtn = document.getElementById('toggleAudio');
    const enterCallBtn = document.getElementById('enterCall');
    const callIdInput = document.getElementById('callId');
    const startCallBtn = document.getElementById('startCall');
    const joinCallBtn = document.getElementById('joinCall');
    const startRecordingBtn = document.getElementById('startRecording');
    const stopRecordingBtn = document.getElementById('stopRecording');
    const asEditorCheckbox = document.getElementById('asEditor');
    const editorInfo = document.getElementById('editorInfo');
    const recordingIcon = document.getElementById('recordingIcon');
    const sceneButtons = [...document.querySelectorAll('#sceneButtons button')];
    const scenes = [...document.querySelectorAll('.scene')];

    const camsLocal = {
      1: document.getElementById('localVideo1'),
      2: document.getElementById('localVideo2'),
      3: document.getElementById('localVideo3'),
      4: document.getElementById('localVideo4'),
      5: document.getElementById('localVideo5'),
      6: document.getElementById('localVideo6'),
    };

    const camsRemote = {
      1: document.getElementById('remoteVideo1'),
      2: document.getElementById('remoteVideo2'),
      3: document.getElementById('remoteVideo3'),
      4: document.getElementById('remoteVideo4'),
      5: document.getElementById('remoteVideo5'),
      6: document.getElementById('remoteVideo6'),
    };

    // Utility functions
    async function getDevices() {
      try {
        const constraints = {
          video: true,
          audio: true,
        };

        // Adjust constraints for mobile devices
        if (/Mobi|Android/i.test(navigator.userAgent)) {
          constraints.video = { facingMode: 'user' }; // Default to front-facing camera
        }

        await navigator.mediaDevices.getUserMedia(constraints);

        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        const audioDevices = devices.filter(d => d.kind === 'audioinput');

        cameraSelect.innerHTML = videoDevices.map((device, index) =>
          `<option value="${device.deviceId}">${device.label || `Cámara ${index + 1}`}</option>`
        ).join('');

        micSelect.innerHTML = audioDevices.map((device, index) =>
          `<option value="${device.deviceId}">${device.label || `Micrófono ${index + 1}`}</option>`
        ).join('');

        if (!videoDevices.length || !audioDevices.length) {
          alert('Por favor, habilita permisos de cámara y micrófono en tu dispositivo.');
        }
      } catch (error) {
        console.error('Error al obtener dispositivos:', error);
        alert('No se pudieron obtener los dispositivos. Verifica los permisos.');
      }
    }

    async function getStreams() {
      try {
        const videoDeviceId = cameraSelect.value;
        const audioDeviceId = micSelect.value;

        localStream1 = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: videoDeviceId ? { exact: videoDeviceId } : undefined },
          audio: { deviceId: audioDeviceId ? { exact: audioDeviceId } : undefined },
        });

        const videoDevices = (await navigator.mediaDevices.enumerateDevices())
          .filter(d => d.kind === 'videoinput');
        const secondCamId = videoDevices.find(d => d.deviceId !== videoDeviceId)?.deviceId;

        localStream2 = secondCamId
          ? await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: secondCamId } }, audio: false })
          : localStream1.clone();

        previewVideo.srcObject = localStream1;
      } catch (error) {
        console.error('Error al obtener streams:', error);
        alert('No se pudieron obtener los streams. Verifica los permisos.');
      }
    }

    function assignLocalStreams() {
      Object.entries(camsLocal).forEach(([key, cam]) => {
        cam.srcObject = key === '1' ? localStream2 : localStream1;
        cam.play().catch(e => console.error(`Error playing local video ${key}:`, e));
      });
    }

    function assignRemoteStream(stream) {
      Object.values(camsRemote).forEach(cam => {
        cam.srcObject = stream;
        cam.play().catch(e => console.error('Error playing remote video:', e));
      });
    }

    function switchScene(sceneId) {
      scenes.forEach(scene => {
        scene.style.display = 'none';
        scene.classList.remove('active');
      });

      sceneButtons.forEach(btn => btn.classList.remove('active'));

      const targetScene = document.getElementById(sceneId);
      const targetButton = document.querySelector(`button[data-scene="${sceneId}"]`);

      if (targetScene && targetButton) {
        targetScene.style.display = 'flex';
        targetScene.classList.add('active');
        targetButton.classList.add('active');

        const localVideos = targetScene.querySelectorAll('video[id^="localVideo"]');
        const remoteVideos = targetScene.querySelectorAll('video[id^="remoteVideo"]');

        localVideos.forEach(video => {
          video.srcObject = localStream1 || localStream2;
          video.play().catch(e => console.error('Error playing local video:', e));
        });

        remoteVideos.forEach(video => {
          if (peerConnection?.getRemoteStreams?.()[0]) {
            video.srcObject = peerConnection.getRemoteStreams()[0];
            video.play().catch(e => console.error('Error playing remote video:', e));
          }
        });
z      }
    }

    function setupSceneButtons() {
      sceneButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const sceneId = btn.getAttribute('data-scene');
          if (sceneId) {
            switchScene(sceneId);
          }
        });
      });
    }

    enterCallBtn.addEventListener('click', async () => {
      isEditor = asEditorCheckbox.checked;
      if (!localStream1) {
        alert('Por favor selecciona cámara y micrófono y acepta permisos.');
        return;
      }

      document.querySelector('.pre-call').classList.add('hide');
      document.querySelector('.controls').classList.remove('hide');
      document.getElementById('sceneButtons').style.display = 'flex';

      initializeSession();
      assignLocalStreams();
      setupEditorControls();
      setDefaultScene();
    });

    startCallBtn.addEventListener('click', async () => {
      peerConnection = new RTCPeerConnection(servers);
      localStream1.getTracks().forEach(track => peerConnection.addTrack(track, localStream1));
      localStream2.getTracks().forEach(track => peerConnection.addTrack(track, localStream2));

      const callDoc = db.ref('calls').push();
      callIdInput.value = callDoc.key;

      const callerCandidatesCollection = callDoc.child('callerCandidates');
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          callerCandidatesCollection.push(event.candidate.toJSON());
        }
      };

      peerConnection.ontrack = event => {
        assignRemoteStream(event.streams[0]);
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      await callDoc.child('offer').set({ type: offer.type, sdp: offer.sdp });

      callDoc.child('answer').on('value', async snapshot => {
        const answer = snapshot.val();
        if (answer && !peerConnection.currentRemoteDescription) {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      callDoc.child('calleeCandidates').on('child_added', snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        peerConnection.addIceCandidate(candidate);
      });
    });

    joinCallBtn.addEventListener('click', async () => {
      const callId = callIdInput.value;
      if (!callId) {
        alert('Por favor ingresa un ID de llamada para unirse.');
        return;
      }

      peerConnection = new RTCPeerConnection(servers);
      localStream1.getTracks().forEach(track => peerConnection.addTrack(track, localStream1));
      localStream2.getTracks().forEach(track => peerConnection.addTrack(track, localStream2));

      const callDoc = db.ref(`calls/${callId}`);
      const answerCandidatesCollection = callDoc.child('calleeCandidates');
      const offerCandidatesCollection = callDoc.child('callerCandidates');

      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          answerCandidatesCollection.push(event.candidate.toJSON());
        }
      };

      peerConnection.ontrack = event => {
        const remoteStream = event.streams[0];
        assignRemoteStream(remoteStream); // Ensure remote streams are assigned properly
      };

      const offerSnapshot = await callDoc.child('offer').once('value');
      const offer = offerSnapshot.val();
      if (!offer) {
        alert('No se encontró una oferta para esta llamada. Verifica el ID de llamada.');
        return;
      }

      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      await callDoc.child('answer').set({ type: answer.type, sdp: answer.sdp });

      offerCandidatesCollection.on('child_added', snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        peerConnection.addIceCandidate(candidate).catch(e => console.error('Error adding ICE candidate:', e));
      });
    });

    toggleVideoBtn.addEventListener('click', () => {
      videoEnabled = !videoEnabled;
      localStream1.getVideoTracks().forEach(track => track.enabled = videoEnabled);
      toggleVideoBtn.classList.toggle('active', videoEnabled);
      toggleVideoBtn.textContent = videoEnabled ? 'Video Activado' : 'Video Desactivado';
    });

    toggleAudioBtn.addEventListener('click', () => {
      audioEnabled = !audioEnabled;
      localStream1.getAudioTracks().forEach(track => track.enabled = audioEnabled);
      toggleAudioBtn.classList.toggle('active', audioEnabled);
      toggleAudioBtn.textContent = audioEnabled ? 'Micrófono Activado' : 'Micrófono Desactivado';
    });

    startRecordingBtn.addEventListener('click', () => {
      if (!isEditor) {
        alert('Solo el editor puede grabar.');
        return;
      }
      recordedChunks = [];
      const activeScene = document.querySelector('.scene.active');
      const mixedStream = new MediaStream();

      activeScene.querySelectorAll('video').forEach(video => {
        video.srcObject?.getTracks().forEach(track => mixedStream.addTrack(track));
      });

      mediaRecorder = new MediaRecorder(mixedStream, { mimeType: 'video/mp4' });
      mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/mp4' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `grabacion_${Date.now()}.mp4`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(url);
        alert('Grabación lista para descargar.');
      };
      mediaRecorder.start();
      startRecordingBtn.disabled = true;
      stopRecordingBtn.disabled = false;
      recordingIcon.style.display = 'block';
    });

    stopRecordingBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        startRecordingBtn.disabled = false;
        stopRecordingBtn.disabled = true;
        recordingIcon.style.display = 'none';
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      await getDevices();
      await getStreams();
      assignLocalStreams();
      setupSceneButtons();
      setDefaultScene();
    });

    cameraSelect.addEventListener('change', async () => {
      await getStreams();
      assignLocalStreams();
    });

    micSelect.addEventListener('change', async () => {
      await getStreams();
      assignLocalStreams();
    });
  </script>
</body>
</html>
