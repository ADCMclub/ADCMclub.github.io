<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ADCM VIDEO</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #111; /* Dark mode background */
      color: #f4f7fa; /* Light text for better contrast */
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #f4f7fa; /* Light heading text for better contrast */
      margin-bottom: 15px;
    }
    video {
      border-radius: 10px;
      background: #000;
      max-width: 100%;
    }
    #videoContainer {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
    }
    video.main {
      border: 2px solid #007bff;
      border-radius: 10px;
      width: 60%;
      height: auto;
    }
    video.small {
      border: 2px solid #28a745;
      border-radius: 10px;
      width: 25%;
      height: auto;
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 10;
      box-shadow: 0 0 8px rgba(0,0,0,0.7);
      background: black;
    }
    .scene {
      position: relative;
      display: none;
      justify-content: center;
      align-items: center;
      gap: 10px;
      width: 100%;
      max-width: 900px;
      margin: 0 auto 20px;
      min-height: 360px;
      background: #222; /* Dark mode for scenes */
      border-radius: 12px;
      padding: 10px;
      box-sizing: border-box;
    }
    .scene.active {
      display: flex;
    }
    .scene-name {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 1.2rem;
      color: #fff;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 5px;
    }
    #sceneButtons {
      display: none; /* Hide scene buttons initially */
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      padding: 10px;
      background: #333; /* Dark background for buttons */
      border-radius: 8px;
    }
    #sceneButtons button {
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background: #555;
      color: #f4f7fa;
      transition: background-color 0.3s;
    }
    #sceneButtons button.active {
      background: #007bff;
      color: white;
    }
    select, input, button {
      margin: 5px;
      padding: 10px;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
      background: #333; /* Dark mode buttons */
      color: #f4f7fa; /* Light text for better contrast on dark buttons */
      border: 1px solid #555;
    }
    .toggle-btn {
      background-color: #ccc;
      color: #000;
      cursor: pointer;
      border: none;
    }
    .toggle-btn.active {
      background-color: #007bff;
      color: #fff;
    }
    .hide {
      display: none;
    }
    #editorInfo {
      font-size: 0.9rem;
      color: #f4f7fa; /* Light text for better contrast */
      margin-top: 10px;
    }
    .pre-call, .controls {
      max-width: 900px;
      margin: 0 auto 20px;
    }
    .editor-controls {
      margin-top: 15px;
    }
    .recording-icon {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background-color: red;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      h1 {
        font-size: 1.5rem;
      }
      video.main {
        width: 100%;
        height: auto;
      }
      video.small {
        width: 40%;
        bottom: 5px;
        right: 5px;
      }
      .scene {
        min-height: 240px;
        padding: 5px;
      }
      #sceneButtons button {
        font-size: 0.9rem;
        padding: 6px 10px;
      }
      select, input, button {
        font-size: 0.9rem;
        padding: 8px;
      }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
</head>
<body>

  <h1>ADCM VIDEO</h1>

  <div class="pre-call section">
    <video id="previewVideo" autoplay muted playsinline style="width: 100%; max-width: 600px; border-radius:10px; background:#000;"></video><br>

    <label for="cameraSelect">Cámara del dispositivo:</label>
    <select id="cameraSelect"></select>

    <label for="micSelect">Micrófono del dispositivo:</label>
    <select id="micSelect"></select><br>

    <button id="toggleVideo" class="toggle-btn active">Video Activado</button>
    <button id="toggleAudio" class="toggle-btn active">Micrófono Activado</button><br>

    <input type="checkbox" id="asEditor" /> <label for="asEditor">Entrar como editor (solo editor graba)</label><br>

    <button id="enterCall">Entrar a la llamada</button>
  </div>

  <div class="controls section hide">
    <!-- Escena 1: Solo cámara 1 -->
    <div id="scene1" class="scene">
      <div class="scene-name">Escena 1</div>
      <video id="localVideo1" class="main" autoplay muted playsinline></video>
      <div class="scene-controls">
        <button class="scene-btn" data-scene="scene2">Ir a Escena 2</button>
      </div>
      <video id="preview1" class="preview" autoplay muted playsinline style="width:120px;position:absolute;top:10px;right:10px;border:2px solid #fff;background:#222;"></video>
    </div>

    <!-- Escena 2: Solo cámara 2 -->
    <div id="scene2" class="scene">
      <div class="scene-name">Escena 2</div>
      <video id="remoteVideo2" class="main" autoplay playsinline></video>
      <div class="scene-controls">
        <button class="scene-btn" data-scene="scene1">Ir a Escena 1</button>
      </div>
      <video id="preview2" class="preview" autoplay muted playsinline style="width:120px;position:absolute;top:10px;right:10px;border:2px solid #fff;background:#222;"></video>
    </div>

    <!-- Escena 3: dos cámaras verticales lado a lado -->
    <div id="scene3" class="scene">
      <div class="scene-name">Escena 3</div>
      <video id="localVideo3" class="main" autoplay muted playsinline></video>
      <video id="remoteVideo3" class="main" autoplay playsinline></video>
      <div class="scene-controls">
        <button class="scene-btn" data-scene="scene4">Ir a Escena 4</button>
      </div>
      <video id="preview3" class="preview" autoplay muted playsinline style="width:120px;position:absolute;top:10px;right:10px;border:2px solid #fff;background:#222;"></video>
    </div>

    <!-- Escena 4: Ambas horizontal -->
    <div id="scene4" class="scene">
      <div class="scene-name">Escena 4</div>
      <video id="localVideo4" class="main" autoplay muted playsinline></video>
      <video id="remoteVideo4" class="main" autoplay playsinline></video>
      <div class="scene-controls">
        <button class="scene-btn" data-scene="scene5">Ir a Escena 5</button>
      </div>
      <video id="preview4" class="preview" autoplay muted playsinline style="width:120px;position:absolute;top:10px;right:10px;border:2px solid #fff;background:#222;"></video>
    </div>

    <!-- Escena 5: Cam1 grande, Cam2 esquina -->
    <div id="scene5" class="scene">
      <div class="scene-name">Escena 5</div>
      <video id="localVideo5" class="main" autoplay muted playsinline></video>
      <video id="remoteVideo5" class="small" autoplay playsinline></video>
      <div class="scene-controls">
        <button class="scene-btn" data-scene="scene6">Ir a Escena 6</button>
      </div>
      <video id="preview5" class="preview" autoplay muted playsinline style="width:120px;position:absolute;top:10px;right:10px;border:2px solid #fff;background:#222;"></video>
    </div>

    <!-- Escena 6: Cam2 grande, Cam1 esquina -->
    <div id="scene6" class="scene">
      <div class="scene-name">Escena 6</div>
      <video id="remoteVideo6" class="main" autoplay playsinline></video>
      <video id="localVideo6" class="small" autoplay muted playsinline></video>
      <div class="scene-controls">
        <button class="scene-btn" data-scene="scene1">Ir a Escena 1</button>
      </div>
      <video id="preview6" class="preview" autoplay muted playsinline style="width:120px;position:absolute;top:10px;right:10px;border:2px solid #fff;background:#222;"></video>
    </div>

    <div style="margin-top: 15px;">
      <input id="callTitle" placeholder="Título de la llamada" style="width: 200px;"/><br>
      <button id="startCall">Crear llamada</button>
      <button id="joinCall">Unirse a llamada</button>
      <input id="callId" placeholder="ID de llamada" style="width: 200px;"/><br><br>
      <span id="callStatus" style="color:#0f0;font-weight:bold;"></span><br>
      <button id="startRecording">Iniciar grabación</button>
      <button id="stopRecording" disabled>Detener grabación</button>
    </div>

    <p id="editorInfo" class="hide">Estás en modo editor. Solo tú puedes grabar.</p>
    <div class="editor-controls"></div>

    <!-- Botones para cambiar de escena -->
    <div id="sceneFooterButtons" style="margin-top:30px; display:flex; justify-content:center; gap:10px;">
      <button class="scene-footer-btn" data-scene="scene1">Escena 1</button>
      <button class="scene-footer-btn" data-scene="scene2">Escena 2</button>
      <button class="scene-footer-btn" data-scene="scene3">Escena 3</button>
      <button class="scene-footer-btn" data-scene="scene4">Escena 4</button>
      <button class="scene-footer-btn" data-scene="scene5">Escena 5</button>
      <button class="scene-footer-btn" data-scene="scene6">Escena 6</button>
    </div>

    <!-- Agrega la previsualización de escenas debajo de los botones de cambio de escena -->
    <div id="scenePreviewContainer" style="margin-top:30px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
      <div style="display:flex; flex-direction:column; align-items:center;">
        <span style="color:#fff;font-size:0.95rem;">Escena 1</span>
        <video id="previewScene1" width="120" height="80" muted playsinline style="background:#222; border:2px solid #555; border-radius:8px;"></video>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center;">
        <span style="color:#fff;font-size:0.95rem;">Escena 2</span>
        <video id="previewScene2" width="120" height="80" muted playsinline style="background:#222; border:2px solid #555; border-radius:8px;"></video>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center;">
        <span style="color:#fff;font-size:0.95rem;">Escena 3</span>
        <video id="previewScene3" width="120" height="80" muted playsinline style="background:#222; border:2px solid #555; border-radius:8px;"></video>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center;">
        <span style="color:#fff;font-size:0.95rem;">Escena 4</span>
        <video id="previewScene4" width="120" height="80" muted playsinline style="background:#222; border:2px solid #555; border-radius:8px;"></video>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center;">
        <span style="color:#fff;font-size:0.95rem;">Escena 5</span>
        <video id="previewScene5" width="120" height="80" muted playsinline style="background:#222; border:2px solid #555; border-radius:8px;"></video>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center;">
        <span style="color:#fff;font-size:0.95rem;">Escena 6</span>
        <video id="previewScene6" width="120" height="80" muted playsinline style="background:#222; border:2px solid #555; border-radius:8px;"></video>
      </div>
    </div>
  </div>

  <div id="recordingIcon" class="recording-icon"></div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC6shbQniv5FeXnJYaSasbGKdYibDWhxV8",
      authDomain: "fir-rtc-1d4a1.firebaseapp.com",
      databaseURL: "https://fir-rtc-1d4a1-default-rtdb.firebaseio.com",
      projectId: "fir-rtc-1d4a1",
      storageBucket: "fir-rtc-1d4a1.appspot.com",
      messagingSenderId: "786317659414",
      appId: "1:786317659414:web:4b9fe6fecc349647d1d437"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // Global variables
    let localStream1, localStream2, peerConnection, mediaRecorder;
    let recordedChunks = [];
    let isEditor = false;
    let sessionId = null;
    let videoEnabled = true;
    let audioEnabled = true;

    // DOM elements
    const previewVideo = document.getElementById('previewVideo');
    const cameraSelect = document.getElementById('cameraSelect');
    const micSelect = document.getElementById('micSelect');
    const toggleVideoBtn = document.getElementById('toggleVideo');
    const toggleAudioBtn = document.getElementById('toggleAudio');
    const enterCallBtn = document.getElementById('enterCall');
    const callIdInput = document.getElementById('callId');
    const startCallBtn = document.getElementById('startCall');
    const joinCallBtn = document.getElementById('joinCall');
    const startRecordingBtn = document.getElementById('startRecording');
    const stopRecordingBtn = document.getElementById('stopRecording');
    const asEditorCheckbox = document.getElementById('asEditor');
    const editorInfo = document.getElementById('editorInfo');
    const recordingIcon = document.getElementById('recordingIcon');
    const sceneButtons = [...document.querySelectorAll('#sceneButtons button')];
    const scenes = [...document.querySelectorAll('.scene')];

    const camsLocal = {
      1: document.getElementById('localVideo1'),
      2: document.getElementById('localVideo2'),
      3: document.getElementById('localVideo3'),
      4: document.getElementById('localVideo4'),
      5: document.getElementById('localVideo5'),
      6: document.getElementById('localVideo6'),
    };

    const camsRemote = {
      1: document.getElementById('remoteVideo1'),
      2: document.getElementById('remoteVideo2'),
      3: document.getElementById('remoteVideo3'),
      4: document.getElementById('remoteVideo4'),
      5: document.getElementById('remoteVideo5'),
      6: document.getElementById('remoteVideo6'),
    };

    // Utility functions
    async function getDevices() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        const audioDevices = devices.filter(d => d.kind === 'audioinput');

        cameraSelect.innerHTML = videoDevices.map((device, index) =>
          `<option value="${device.deviceId}">${device.label || `Cámara ${index + 1}`}</option>`
        ).join('');

        micSelect.innerHTML = audioDevices.map((device, index) =>
          `<option value="${device.deviceId}">${device.label || `Micrófono ${index + 1}`}</option>`
        ).join('');

        if (!videoDevices.length || !audioDevices.length) {
          alert('Por favor, habilita permisos de cámara y micrófono en tu dispositivo.');
        }
      } catch (error) {
        console.error('Error al obtener dispositivos:', error);
        alert('No se pudieron obtener los dispositivos. Verifica los permisos.');
      }
    }

    async function getStreams() {
      try {
        const videoDeviceId = cameraSelect.value;
        const audioDeviceId = micSelect.value;

        localStream1 = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: videoDeviceId ? { exact: videoDeviceId } : undefined },
          audio: { deviceId: audioDeviceId ? { exact: audioDeviceId } : undefined },
        });

        const videoDevices = (await navigator.mediaDevices.enumerateDevices())
          .filter(d => d.kind === 'videoinput');
        const secondCamId = videoDevices.find(d => d.deviceId !== videoDeviceId)?.deviceId;

        localStream2 = secondCamId
          ? await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: secondCamId } }, audio: false })
          : localStream1.clone();

        previewVideo.srcObject = localStream1;
        previewVideo.play().catch(e => console.error('Error playing preview video:', e));
      } catch (error) {
        console.error('Error al obtener streams:', error);
        alert('No se pudieron obtener los streams. Verifica los permisos.');
      }
    }

    function assignLocalStreams() {
      Object.entries(camsLocal).forEach(([key, cam]) => {
        cam.srcObject = key === '1' ? localStream2 : localStream1;
        cam.play().catch(e => console.error(`Error playing local video ${key}:`, e));
      });
    }

    function toggleStream(trackType, enabled, button, activeText, inactiveText) {
      localStream1.getTracks().filter(track => track.kind === trackType).forEach(track => track.enabled = enabled);
      button.classList.toggle('active', enabled);
      button.textContent = enabled ? activeText : inactiveText;
    }

    toggleVideoBtn.addEventListener('click', () => {
      videoEnabled = !videoEnabled;
      toggleStream('video', videoEnabled, toggleVideoBtn, 'Video Activado', 'Video Desactivado');
    });

    toggleAudioBtn.addEventListener('click', () => {
      audioEnabled = !audioEnabled;
      toggleStream('audio', audioEnabled, toggleAudioBtn, 'Micrófono Activado', 'Micrófono Desactivado');
    });

    cameraSelect.addEventListener('change', async () => {
      await getStreams();
      assignLocalStreams();
    });

    micSelect.addEventListener('change', async () => {
      await getStreams();
      assignLocalStreams();
    });

    // Cambia la escena y resalta el botón activo
    function switchScene(sceneId) {
      scenes.forEach(scene => {
        scene.style.display = 'none';
        scene.classList.remove('active');
      });
      const targetScene = document.getElementById(sceneId);
      if (targetScene) {
        targetScene.style.display = 'flex';
        targetScene.classList.add('active');
      }
      // Resalta el botón activo
      document.querySelectorAll('.scene-footer-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-scene') === sceneId);
      });

      // Asigna los streams correctos a cada escena según la descripción
      assignSceneStreams(sceneId);
    }

    // Asigna los streams correctos a los videos de cada escena según la descripción
    function assignSceneStreams(sceneId) {
      // Usuario 1: localStream1, Usuario 2: remoteStream (peerConnection) o localStream2 si no hay conexión
      const remoteStream = peerConnection?.getRemoteStreams?.()[0] || localStream2;

      // Mostrar SIEMPRE los videos de la escena activa, ocultar los demás
      Object.entries(camsLocal).forEach(([k, v]) => v && (v.style.display = 'none'));
      Object.entries(camsRemote).forEach(([k, v]) => v && (v.style.display = 'none'));

      if (sceneId === 'scene1') {
        camsLocal[1].srcObject = localStream1;
        camsLocal[1].style.display = '';
      } else if (sceneId === 'scene2') {
        camsRemote[2].srcObject = remoteStream;
        camsRemote[2].style.display = '';
      } else if (sceneId === 'scene3') {
        camsLocal[3].srcObject = localStream1;
        camsRemote[3].srcObject = remoteStream;
        camsLocal[3].style.display = '';
        camsRemote[3].style.display = '';
      } else if (sceneId === 'scene4') {
        camsLocal[4].srcObject = localStream1;
        camsRemote[4].srcObject = remoteStream;
        camsLocal[4].style.display = '';
        camsRemote[4].style.display = '';
      } else if (sceneId === 'scene5') {
        camsLocal[5].srcObject = localStream1;
        camsRemote[5].srcObject = remoteStream;
        camsLocal[5].style.display = '';
        camsRemote[5].style.display = '';
      } else if (sceneId === 'scene6') {
        camsRemote[6].srcObject = remoteStream;
        camsLocal[6].srcObject = localStream1;
        camsRemote[6].style.display = '';
        camsLocal[6].style.display = '';
      }
    }

    // Scene change buttons logic
    function setupSceneButtons() {
      document.querySelectorAll('.scene-btn').forEach(btn => {
        btn.onclick = function() {
          switchScene(this.getAttribute('data-scene'));
        };
      });
    }

    // Botones de cambio de escena en el pie
    function setupSceneFooterButtons() {
      document.querySelectorAll('.scene-footer-btn').forEach(btn => {
        btn.onclick = function() {
          switchScene(this.getAttribute('data-scene'));
        };
      });
    }

    // Set default scene
    function setDefaultScene() {
      switchScene('scene4');
    }

    // Helper: disable all tracks in a stream
    function disableAllTracks(stream) {
      if (!stream) return;
      stream.getTracks().forEach(track => track.enabled = false);
    }

    // Show/hide editor info and disable video/audio for editor
    function updateEditorInfo() {
      if (isEditor) {
        editorInfo.classList.remove('hide');
        // Disable all tracks for editor (no video/audio sent)
        disableAllTracks(localStream1);
        disableAllTracks(localStream2);
        // Hide local video elements for editor
        Object.values(camsLocal).forEach(cam => {
          cam.style.display = 'none';
        });
        // Hide preview video in scenes for editor
        for (let i = 1; i <= 6; i++) {
          const preview = document.getElementById('preview' + i);
          if (preview) preview.style.display = 'none';
        }
        // Hide preview in pre-call
        previewVideo.style.display = 'none';
        // Disable toggle buttons for editor
        toggleVideoBtn.disabled = true;
        toggleAudioBtn.disabled = true;
      } else {
        editorInfo.classList.add('hide');
        // Enable all tracks for non-editor
        localStream1?.getTracks().forEach(track => track.enabled = true);
        localStream2?.getTracks().forEach(track => track.enabled = true);
        // Show local video elements for non-editor
        Object.values(camsLocal).forEach(cam => {
          cam.style.display = '';
        });
        // Show preview videos in scenes for non-editor
        for (let i = 1; i <= 6; i++) {
          const preview = document.getElementById('preview' + i);
          if (preview) preview.style.display = '';
        }
        // Show preview in pre-call
        previewVideo.style.display = '';
        // Enable toggle buttons for non-editor
        toggleVideoBtn.disabled = false;
        toggleAudioBtn.disabled = false;
      }
    }

    // Recording logic with editor check
    startRecordingBtn.addEventListener('click', () => {
      if (!isEditor) {
        alert('Solo el editor puede grabar.');
        return;
      }
      recordedChunks = [];
      const activeScene = document.querySelector('.scene.active');
      const mixedStream = new MediaStream();
      activeScene.querySelectorAll('video').forEach(video => {
        if (video.srcObject) {
          video.srcObject.getTracks().forEach(track => {
            if (!mixedStream.getTracks().includes(track)) mixedStream.addTrack(track);
          });
        }
      });
      mediaRecorder = new MediaRecorder(mixedStream, { mimeType: 'video/webm' });
      mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `grabacion_${Date.now()}.webm`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(url);
        alert('Grabación lista para descargar.');
      };
      mediaRecorder.start();
      startRecordingBtn.disabled = true;
      stopRecordingBtn.disabled = false;
      recordingIcon.style.display = 'block';
    });

    stopRecordingBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        startRecordingBtn.disabled = false;
        stopRecordingBtn.disabled = true;
        recordingIcon.style.display = 'none';
      }
    });

    // Initialization
    document.addEventListener('DOMContentLoaded', async () => {
      await getDevices();
      await getStreams();
      assignLocalStreams();
      setupSceneButtons();
      setupSceneFooterButtons();
      setDefaultScene();
      updateEditorInfo();
      assignSceneStreams('scene4');
    });

    enterCallBtn.addEventListener('click', async () => {
      isEditor = asEditorCheckbox.checked;
      if (!localStream1) {
        alert('Por favor selecciona cámara y micrófono y acepta permisos.');
        return;
      }
      document.querySelector('.pre-call').classList.add('hide');
      document.querySelector('.controls').classList.remove('hide');
      assignLocalStreams();
      setDefaultScene();
      setupSceneButtons();
      setupSceneFooterButtons();
      updateEditorInfo();
      // Forzar mostrar el video local en la escena predeterminada
      assignSceneStreams('scene4');
    });

    // Utilidad para generar un ID corto (6 caracteres alfanuméricos)
    function generateShortId() {
      return Math.random().toString(36).substr(2, 6).toUpperCase();
    }

    // Mostrar estado de conexión
    function setCallStatus(msg, color = "#0f0") {
      const el = document.getElementById('callStatus');
      el.textContent = msg;
      el.style.color = color;
    }

    // Call creation/join logic
    let callRef = null;
    let callerCandidatesCollection = null;
    let calleeCandidatesCollection = null;

    document.getElementById('startCall').addEventListener('click', async () => {
      // Genera un ID corto y lo usa como clave
      const shortId = generateShortId();
      callRef = db.ref('calls/' + shortId);
      callIdInput.value = shortId;

      // Guarda el título si se proporciona
      const title = document.getElementById('callTitle').value.trim();
      if (title) await callRef.child('title').set(title);

      peerConnection = new RTCPeerConnection(servers);
      localStream1.getTracks().forEach(track => peerConnection.addTrack(track, localStream1));
      localStream2.getTracks().forEach(track => peerConnection.addTrack(track, localStream2));

      callerCandidatesCollection = callRef.child('callerCandidates');
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          callerCandidatesCollection.push(event.candidate.toJSON());
        }
      };

      peerConnection.ontrack = event => {
        assignRemoteStream(event.streams[0]);
      };

      peerConnection.onconnectionstatechange = () => {
        if (peerConnection.connectionState === "connected") setCallStatus("Conectado", "#0f0");
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      await callRef.child('offer').set({ type: offer.type, sdp: offer.sdp });

      callRef.child('answer').on('value', async snapshot => {
        const answer = snapshot.val();
        if (answer && !peerConnection.currentRemoteDescription) {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      callRef.child('calleeCandidates').on('child_added', snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        peerConnection.addIceCandidate(candidate);
      });

      setCallStatus("Esperando conexión...", "#ff0");
    });

    document.getElementById('joinCall').addEventListener('click', async () => {
      const callId = callIdInput.value.trim();
      if (!callId) {
        alert('Por favor ingresa un ID de llamada para unirse.');
        return;
      }

      callRef = db.ref('calls/' + callId);

      // Verifica si existe la llamada
      const offerSnapshot = await callRef.child('offer').once('value');
      const offer = offerSnapshot.val();
      if (!offer) {
        alert('No se encontró una oferta para esta llamada. Verifica el ID de llamada.');
        setCallStatus("ID no válido", "#f00");
        return;
      }

      peerConnection = new RTCPeerConnection(servers);
      localStream1.getTracks().forEach(track => peerConnection.addTrack(track, localStream1));
      localStream2.getTracks().forEach(track => peerConnection.addTrack(track, localStream2));

      calleeCandidatesCollection = callRef.child('calleeCandidates');
      const offerCandidatesCollection = callRef.child('callerCandidates');

      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          calleeCandidatesCollection.push(event.candidate.toJSON());
        }
      };

      peerConnection.ontrack = event => {
        assignRemoteStream(event.streams[0]);
      };

      peerConnection.onconnectionstatechange = () => {
        if (peerConnection.connectionState === "connected") setCallStatus("Conectado", "#0f0");
      };

      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      await callRef.child('answer').set({ type: answer.type, sdp: answer.sdp });

      offerCandidatesCollection.on('child_added', snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        peerConnection.addIceCandidate(candidate).catch(e => console.error('Error adding ICE candidate:', e));
      });

      setCallStatus("Conectando...", "#ff0");
    });

    // Previsualización de escenas: muestra cómo se vería cada escena (composición grupal)
    function updateScenePreviews() {
      // Usuario 1: localStream1, Usuario 2: remoteStream (peerConnection) o localStream2
      const remoteStream = peerConnection?.getRemoteStreams?.()[0] || localStream2;

      // Escena 1: Solo usuario 1 (solo local)
      setPreviewScene('previewScene1', [localStream1], 'single');
      // Escena 2: Solo usuario 2 (solo remoto)
      setPreviewScene('previewScene2', [remoteStream], 'single');
      // Escena 3: usuario 1 y 2 vertical alado horizontalmente (ambos)
      setPreviewScene('previewScene3', [localStream1, remoteStream], 'side');
      // Escena 4: usuario 1 y 2 horizontal uno alado del otro (ambos)
      setPreviewScene('previewScene4', [localStream1, remoteStream], 'side');
      // Escena 5: usuario 1 grande, usuario 2 pequeño a un lado (ambos)
      setPreviewScene('previewScene5', [localStream1, remoteStream], 'pip1');
      // Escena 6: usuario 2 grande, usuario 1 pequeño a un lado (ambos)
      setPreviewScene('previewScene6', [remoteStream, localStream1], 'pip2');
    }

    // Helper para mostrar la composición de la escena en un canvas y ponerlo en el video de preview
    function setPreviewScene(previewId, streams, layout = 'single') {
      const preview = document.getElementById(previewId);
      if (!preview) return;

      // Detener cualquier stream anterior
      if (preview.srcObject) {
        preview.srcObject.getTracks().forEach(track => track.stop && track.stop());
        preview.srcObject = null;
      }

      // Si solo hay un stream, mostrarlo directo
      if (streams.length === 1 || layout === 'single') {
        preview.srcObject = streams[0] || null;
        preview.play().catch(() => {});
        return;
      }

      // Si hay dos streams, hacer composición en canvas (grupal)
      const canvas = document.createElement('canvas');
      canvas.width = 120;
      canvas.height = 80;
      const ctx = canvas.getContext('2d');
      const v1 = document.createElement('video');
      const v2 = document.createElement('video');
      v1.muted = true; v2.muted = true;
      v1.autoplay = true; v2.autoplay = true;
      v1.playsInline = true; v2.playsInline = true;
      v1.srcObject = streams[0] || null;
      v2.srcObject = streams[1] || null;

      // Esperar a que ambos videos estén listos
      Promise.all([
        new Promise(res => v1.onloadeddata = res),
        new Promise(res => v2.onloadeddata = res)
      ]).then(() => {
        function draw() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          if (layout === 'side') {
            // Dos videos lado a lado (grupal)
            ctx.drawImage(v1, 0, 0, canvas.width / 2, canvas.height);
            ctx.drawImage(v2, canvas.width / 2, 0, canvas.width / 2, canvas.height);
          } else if (layout === 'pip1') {
            // Usuario 1 grande, usuario 2 pequeño esquina (grupal)
            ctx.drawImage(v1, 0, 0, canvas.width, canvas.height);
            ctx.drawImage(v2, canvas.width - 40, canvas.height - 30, 40, 30);
          } else if (layout === 'pip2') {
            // Usuario 2 grande, usuario 1 pequeño esquina (grupal)
            ctx.drawImage(v1, 0, 0, canvas.width, canvas.height);
            ctx.drawImage(v2, canvas.width - 40, canvas.height - 30, 40, 30);
          }
          requestAnimationFrame(draw);
        }
        draw();
      });

      // Asigna el stream del canvas al video de preview
      const stream = canvas.captureStream();
      preview.srcObject = stream;
      preview.play().catch(() => {});
    }

    // Llama a updateScenePreviews cuando cambian los streams o al iniciar
    document.addEventListener('DOMContentLoaded', () => {
      updateScenePreviews();
    });
    cameraSelect.addEventListener('change', async () => {
      await getStreams();
      assignLocalStreams();
      updateScenePreviews();
    });
    micSelect.addEventListener('change', async () => {
      await getStreams();
      assignLocalStreams();
      updateScenePreviews();
    });
    enterCallBtn.addEventListener('click', () => {
      updateScenePreviews();
    });

    // También actualiza las previsualizaciones cuando se asignan los streams
    function assignLocalStreams() {
      Object.entries(camsLocal).forEach(([key, cam]) => {
        cam.srcObject = key === '1' ? localStream2 : localStream1;
        cam.play().catch(e => console.error(`Error playing local video ${key}:`, e));
      });
      updateScenePreviews();
    }
  </script>
</body>
</html>